<!-- 
    @author:  zZZ....
    @description:
    @date: 2022/6/8
-->

    <title>zZZ.... | 正在查看留言，评论</title>

    <style>
        .divide-y>div{
            border-radius: 4px;
        }
        .divide-y>div:hover{
            background-color: #eeeeee7d;
            Cursor:pointer;
        }

        .divide-y>div:hover a{
            text-decoration: none;
            display: inline-block;
        }
        a {
            color: #337ab7;
            text-decoration: none;
        }
        .media {
            overflow: hidden;
            zoom: 1;
            margin-top: 15px;
        }

        .media-body, .media-left, .media-right {
            display: table-cell;
            vertical-align: top;
        }
        .media-left, .media>.pull-left {
            padding-right: 10px;
        }
        .media-object {
             display: block;
         }

        img {
            border: 0;
            max-width: max-content;
            border-radius: 10px;
        }

        .text-truncate>strong {
            font-size: 1rem;
            color: wheat;
        }
        .text-truncate > a {
            color: wheat;
        }




    </style>

        <div class="container-xl">
            <!-- Page title -->
            <div class="page-header d-print-none">
                <div class="row align-items-center">
                    <div class="col">
                        <h2 class="page-title" onclick="cc()">
                            Activity
                        </h2>
                    </div>
                    <div class="col-auto ms-auto d-print-none">
                        <div class="d-flex">
                            <a id="example" onclick="readAll()"  data-toggle="tooltip" title="全部标记已读" href="JavaScript:void(0)" style="color: white" >
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mail-opened" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.75" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                    <polyline points="3 9 12 15 21 9 12 3 3 9"></polyline>
                                    <path d="M21 9v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10"></path>
                                    <line x1="3" y1="19" x2="9" y2="13"></line>
                                    <line x1="15" y1="13" x2="21" y2="19"></line>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="page-body">
            <div class="container-xl">
                <div class="row justify-content-center">
                    <div class="col-lg-8 col-sm-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="divide-y" id="guest_divide_comment">

                                    <!--留言列表-->


                                    <div class="class-blog-placeholder">
                                        <div class="row align-items-center">
                                            <div class="col-1">
                                                <div class="avatar avatar-rounded placeholder"></div>
                                            </div>
                                            <div class="col-5">
                                                <div class="placeholder placeholder-xs col-12"></div>
                                                <div class="placeholder placeholder-xs col-5"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="class-blog-placeholder">
                                        <div class="row align-items-center">
                                            <div class="col-1">
                                                <div class="avatar avatar-rounded placeholder"></div>
                                            </div>
                                            <div class="col-5">
                                                <div class="placeholder placeholder-xs col-12"></div>
                                                <div class="placeholder placeholder-xs col-5"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="class-blog-placeholder">
                                        <div class="row align-items-center">
                                            <div class="col-1">
                                                <div class="avatar avatar-rounded placeholder"></div>
                                            </div>
                                            <div class="col-5">
                                                <div class="placeholder placeholder-xs col-12"></div>
                                                <div class="placeholder placeholder-xs col-5"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="class-blog-placeholder">
                                        <div class="row align-items-center">
                                            <div class="col-1">
                                                <div class="avatar avatar-rounded placeholder"></div>
                                            </div>
                                            <div class="col-5">
                                                <div class="placeholder placeholder-xs col-12"></div>
                                                <div class="placeholder placeholder-xs col-5"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="class-blog-placeholder">
                                        <div class="row align-items-center">
                                            <div class="col-1">
                                                <div class="avatar avatar-rounded placeholder"></div>
                                            </div>
                                            <div class="col-5">
                                                <div class="placeholder placeholder-xs col-12"></div>
                                                <div class="placeholder placeholder-xs col-5"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="class-blog-placeholder">
                                        <div class="row align-items-center">
                                            <div class="col-1">
                                                <div class="avatar avatar-rounded placeholder"></div>
                                            </div>
                                            <div class="col-5">
                                                <div class="placeholder placeholder-xs col-12"></div>
                                                <div class="placeholder placeholder-xs col-5"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="class-blog-placeholder">
                                        <div class="row align-items-center">
                                            <div class="col-1">
                                                <div class="avatar avatar-rounded placeholder"></div>
                                            </div>
                                            <div class="col-5">
                                                <div class="placeholder placeholder-xs col-12"></div>
                                                <div class="placeholder placeholder-xs col-5"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="class-blog-placeholder">
                                        <div class="row align-items-center">
                                            <div class="col-1">
                                                <div class="avatar avatar-rounded placeholder"></div>
                                            </div>
                                            <div class="col-5">
                                                <div class="placeholder placeholder-xs col-12"></div>
                                                <div class="placeholder placeholder-xs col-5"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="class-blog-placeholder">
                                        <div class="row align-items-center">
                                            <div class="col-1">
                                                <div class="avatar avatar-rounded placeholder"></div>
                                            </div>
                                            <div class="col-5">
                                                <div class="placeholder placeholder-xs col-12"></div>
                                                <div class="placeholder placeholder-xs col-5"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="class-blog-placeholder">
                                        <div class="row align-items-center">
                                            <div class="col-1">
                                                <div class="avatar avatar-rounded placeholder"></div>
                                            </div>
                                            <div class="col-5">
                                                <div class="placeholder placeholder-xs col-12"></div>
                                                <div class="placeholder placeholder-xs col-5"></div>
                                            </div>
                                        </div>
                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


<div class="modal modal-blur fade"  id="modal-large" tabindex="-1" style="display: none;overflow: auto" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Large modal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="guest_alter">

            </div>
            <div class="modal-body" id="modal-body">

                    <!--  单个留言树-->

            </div>
        </div>
    </div>
</div>
<!-- 删除模态框 -->
<div class="modal  fade" id="modal-danger" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div class="modal-content">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="modal-status bg-danger"></div>
            <div class="modal-body text-center py-4">
                <!-- Download SVG icon from http://tabler-icons.io/i/alert-triangle -->
                <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-danger icon-lg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 9v2m0 4v.01"></path><path d="M5 19h14a2 2 0 0 0 1.84 -2.75l-7.1 -12.25a2 2 0 0 0 -3.5 0l-7.1 12.25a2 2 0 0 0 1.75 2.75"></path></svg>
                <h3>Are you sure?</h3>
                <!--                <div class="text-muted">Do you really want to remove 84 files? What you've done cannot be undone.</div>-->
            </div>
            <div class="modal-footer">
                <div class="w-100">
                    <div class="row">
                        <div class="col" onclick="delete_b(this)" id="blog_guestBook_del"><a href="#"  class="btn btn-danger w-100" data-bs-dismiss="modal">
                            Delete
                        </a></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script>



    function guestRecycle(e) {

        document.getElementById('blog_guestBook_del').setAttribute("data-guest-id",e.getAttribute('data-guest-id'));
                event.stopPropagation();
                return false;
    }

    function readAll() {
        let ids = '';
        let elementNodeListOf = document.getElementById('guest_divide_comment').querySelectorAll('span[data-guest-read]');
        if (elementNodeListOf){

            for (let i = 0; i < elementNodeListOf.length; i++) {
                let attribute = elementNodeListOf[i].getAttribute("data-guest-read");
                ids+=','+attribute;
                elementNodeListOf[i].remove();
            }
        }
        $.get({
            url:'/GuestBookController/isRead?id='+ids.replace(',',''),
            success:function (res) {
                if (res.success){
                    blogAlter('','已全部标记为已读~')
                }else {
                    blogAlter('┗|｀O′|┛ 嗷~~','可能发生了一点小故障~')
                }

            }
        })
    }



    function guestDateList(currentPage,pageSize,queryPerm){

        if (currentPage === undefined || currentPage <=0 ){
            currentPage =1;
        }
        if(pageSize === undefined || pageSize <=0){
            pageSize =10;
        }
        pageDataGuestBook ={currentPage:currentPage,pageSize:pageSize,p:queryPerm};
        $.ajax({
            url:'/GuestBookController/adminList',
            type:'post',
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            data:JSON.stringify(pageDataGuestBook),
            beforeSend:function(e){
                $("#guest_divide_comment").append($(".class-blog-placeholder"));
                $(".class-blog-placeholder").show();
            },
            success:function (res) {
                let list = res.data.list;
                if (res.success ){

                    let divs ='';

                    for (let i = 0; i < list.length; i++) {
                        let  obj = list[i];

                        if(! obj.readi){
                             obj.span= '<span class="status-dot status-dot-animated status-azure" data-guest-read="'+ obj.id+'"></span>'
                        }else {
                             obj.span='';
                        }

                        let comment = ' <div>\n' +
                            '                                        <div class="row"  onclick="blogModal(this)" data-guest-id="'+ obj.id+'">\n' +
                            '                                            <div class="col-auto">\n' +
                            '                                                <span class="avatar" style="background-image: url('+obj.headShot+'),url(/medias/Anonymous.jpg)"></span>\n' +
                            '                                            </div>\n' +
                            '                                            <div class="col">\n' +
                            '                                                <div class="text-truncate">\n' +
                            '                                                    <strong>'+obj.nickname+'</strong>  ' +
                            ''+obj.content+'' +
                            '                                                </div>\n' +
                            '                                                <div class="text-muted">'+obj.createDate+'</div>\n' +
                            '                                            </div>\n' +
                            '                                            <div class="col-auto align-self-center">\n' +
                            '                                                <a   data-bs-toggle="modal" data-bs-target="#modal-danger"  onclick="guestRecycle(this)"  style="color: white" data-guest-id="'+obj.id+'"  class="blog-display">\n' +
                            '                                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><line x1="4" y1="7" x2="20" y2="7"></line><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"></path></svg>\n' +
                            '                                                </a>\n' +
                            obj.span+
                            '                                            </div>\n' +
                            '                                        </div>\n' +
                            '                                    </div>';

                        divs+=comment;



                    }

                    window.requestAnimationFrame(function (e) {
                        $('#guest_divide_comment').append(divs);
                    });

                    if (res.data.list &&  res.data.list.length<pageDataGuestBook.pageSize){
                        window.zScrollObj.guestBook=false;
                    }

                }else {

                }
            },
            complete:function(xhr,ts){
                $(".class-blog-placeholder").hide();
            },
            error:function () {

            }
        })
    }


    function blogModal(e) {
        let $modal = $('#modal-large');
        let id = e.getAttribute('data-guest-id');
        $modal[0].setAttribute('data-guest-id',id);
        $modal.modal('show');
    }

    $(function () {

        guestDateList();

        $('#example').tooltip();

        $('#modal-large').on('show.bs.modal', function (e) {
            let modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = '';
            let media= '<div class="media" data-guest-ele="@name@" data-guest-media-id="@id@">\n' +
                '    <div class="media-left">\n' +
                '        <a href="#">\n' +
                '            <img class="media-object" onerror="imgHeardDefault(this)" data-src="holder.js/64x64" alt="64x64" src="@headShot@" data-holder-rendered="true" style="width: 64px; height: 64px;">\n' +
                '        </a>\n' +
                '    </div>\n' +
                '    <div class="media-body">\n' +
                '        <h4 class="media-heading">@nickname@ <em style="font-size: xx-small;color: wheat">@createDate@</em></h4>' +
                '@content@</div>\n' +
                '</div>';
            let id = e.currentTarget.getAttribute('data-guest-id');
            $.ajax({
                url:'/GuestBookController/getComment?id='+id,
                type:'get',
                success:function (res) {
                    modalBody.innerHTML = '';
                    if (res.success){
                        let data = res.data;
                        let top = data.top;
                        let child = data.child;

                        let myself = data.myself;

                        let myselfEle= strToEleByObj(media,myself);
                        if (child){
                            let myselfEleBody  = myselfEle.querySelector('.media-body');
                            for (let i = 0; i < child.length; i++) {
                                let chi = child[i];

                                myselfEleBody.append(strToEleByObj(media,chi));
                            }
                        }
                        if (top){

                            let eleTop= strToEleByObj(media,top);
                            let eleTopBody  = eleTop.querySelector('.media-body');
                            modalBody.append(eleTop);

                            let siblings = data.siblings;
                            if (siblings){
                                for (let i = 0; i < siblings.length; i++) {
                                    let sibling = siblings[i];
                                    eleTopBody.append(strToEleByObj(media,sibling));
                                }
                            }
                            eleTopBody.append(myselfEle);

                        }else {
                            modalBody.append(myselfEle);
                        }

                        guestIsRead(id); //标记已读

                    }else {
                        modalBody.innerHTML = '<h1>没查到数据(⊙o⊙)？</h1>';
                    }
                },
                error:function (e) {
                    modalBody.innerHTML = '<h1>没查到数据(⊙o⊙)？</h1>';
                },
                beforeSend:function () {
                    modalBody.innerHTML ='<h1>Loading<span class="animated-dots"></span></h1>';
                }
            });


            e.currentTarget.removeAttribute('data-guest-id')
        })



    });



</script>

