<!-- 
    @author:  zZZ....
    @description:
    @date: 2022/6/8
-->

    <title>zZZ.... | 正在查看留言，评论</title>

    <style>
        .divide-y>div{
            border-radius: 4px;
        }
        .divide-y>div:hover{
            background-color: #eeeeee7d;
            Cursor:pointer;
        }

        .divide-y>div:hover a{
            color: #6d39ff;
            display: inline-block;
        }
        a {
            color: #337ab7;
            text-decoration: none;
        }
        .media {
            overflow: hidden;
            zoom: 1;
            margin-top: 15px;
        }

        .media-body, .media-left, .media-right {
            display: table-cell;
            vertical-align: top;
        }
        .media-left, .media>.pull-left {
            padding-right: 10px;
        }
        .media-object {
             display: block;
         }

        img {
            border: 0;
            max-width: max-content;
            border-radius: 10px;
        }






    </style>

        <div class="container-xl">
            <!-- Page title -->
            <div class="page-header d-print-none">
                <div class="row align-items-center">
                    <div class="col">
                        <h2 class="page-title" onclick="cc()">
                            Activity
                        </h2>
                    </div>
                    <div class="col-auto ms-auto d-print-none">
                        <div class="d-flex">
                            <a id="example" onclick="readAll()"  data-toggle="tooltip" title="全部标记已读" href="JavaScript:void(0)" style="color: #9b9c9d" >
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mail-opened" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.75" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                    <polyline points="3 9 12 15 21 9 12 3 3 9"></polyline>
                                    <path d="M21 9v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10"></path>
                                    <line x1="3" y1="19" x2="9" y2="13"></line>
                                    <line x1="15" y1="13" x2="21" y2="19"></line>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="page-body">
            <div class="container-xl">
                <div class="row justify-content-center">
                    <div class="col-lg-8 col-sm-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="divide-y" id="guest_divide_comment">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


<div class="modal modal-blur fade"  id="modal-large" tabindex="-1" style="display: none;overflow: auto" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Large modal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="guest_alter">

            </div>
            <div class="modal-body" id="modal-body">

                    <!--  单个留言树-->

            </div>
        </div>
    </div>
</div>



<script>



    function guestRecycle(e) {
                $.get({
                    url:'/blogs/GuestBookController/recycle?id='+e.getAttribute('data-guest-id'),
                    success:function (res) {
                        if (res.success){
                            e.parentElement.parentElement.parentElement.parentElement.remove();
                            blogAlter('','该条评论已经放入回收站哦~');
                        }else {
                            blogAlter('┗|｀O′|┛ 嗷~~','可能发生了一点小故障~')
                        }

                    }
                });
                e.stopPropagation();
    }

    function readAll() {
        let ids = '';
        let elementNodeListOf = document.getElementById('guest_divide_comment').querySelectorAll('span[data-guest-read]');
        if (elementNodeListOf){

            for (let i = 0; i < elementNodeListOf.length; i++) {
                let attribute = elementNodeListOf[i].getAttribute("data-guest-read");
                ids+=','+attribute;
                elementNodeListOf[i].remove();
            }
        }
        $.get({
            url:'/blogs/GuestBookController/isRead?id='+ids.replace(',',''),
            success:function (res) {
                if (res.success){
                    blogAlter('','已全部标记为已读哦~')
                }else {
                    blogAlter('┗|｀O′|┛ 嗷~~','可能发生了一点小故障~')
                }

            }
        })
    }



    function guestDateList(currentPage,pageSize,queryPerm){

        if (currentPage === undefined || currentPage <=0 ){
            currentPage =1;
        }
        if(pageSize === undefined || pageSize <=0){
            pageSize =10;
        }
        pageDataGuestBook ={currentPage:currentPage,pageSize:pageSize,p:queryPerm};
        $.ajax({
            url:'/blogs/GuestBookController/adminList',
            type:'post',
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            data:JSON.stringify(pageDataGuestBook),
            success:function (res) {
                let list = res.data.list;
                if (res.success && list.length != 0){
                    let divComment = document.getElementById('guest_divide_comment');
                    divComment.innerHTML= '';
                    let comment = ' <div>\n' +
                        '                                        <div class="row"  onclick="blogModal(this)" data-guest-id="@id@">\n' +
                        '                                            <div class="col-auto">\n' +
                        '                                                <span class="avatar" style="background-image: url(@headShot@),url(/blogs/medias/Anonymous.jpg)"></span>\n' +
                        '                                            </div>\n' +
                        '                                            <div class="col">\n' +
                        '                                                <div class="text-truncate">\n' +
                        '                                                    <strong>@nickname@</strong>  ' +
                        '@content@' +
                        '                                                </div>\n' +
                        '                                                <div class="text-muted">@createDate@</div>\n' +
                        '                                            </div>\n' +
                        '                                            <div class="col-auto align-self-center">\n' +
                        '                                                <a  onclick="guestRecycle(this)"  style="color: #6d39ff" data-guest-id="@id@"  class="blog-display">\n' +
                        '                                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><line x1="4" y1="7" x2="20" y2="7"></line><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"></path></svg>\n' +
                        '                                                </a>\n' +
                           ' @span@'+
                        '                                            </div>\n' +
                        '                                        </div>\n' +
                        '                                    </div>';

                    for (let i = 0; i < list.length; i++) {
                        let listElement = list[i];
                        if(!listElement.readi){
                            listElement.span= '<span class="status-dot status-dot-animated status-azure" data-guest-read="'+listElement.id+'"></span>'
                        }else {
                            listElement.span='';
                        }
                        let ele = strToEleByObj(comment,listElement);
                        if(ele){
                            divComment.append(ele);
                        }
                    }

                }else {
                    blogAlter('┗|｀O′|┛ 嗷~~','可能发生了一点小故障~')

                }
            },
            error:function () {

            }
        })
    }


    function blogModal(e) {
        let $modal = $('#modal-large');
        let id = e.getAttribute('data-guest-id');
        $modal[0].setAttribute('data-guest-id',id);
        $modal.modal('show');
    }

    $(function () {

        guestDateList();

        $('#example').tooltip();

        $('#modal-large').on('show.bs.modal', function (e) {
            let modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = '';
            let media= '<div class="media" data-guest-ele="@name@" data-guest-media-id="@id@">\n' +
                '    <div class="media-left">\n' +
                '        <a href="#">\n' +
                '            <img class="media-object" onerror="imgHeardDefault(this)" data-src="holder.js/64x64" alt="64x64" src="@headShot@" data-holder-rendered="true" style="width: 64px; height: 64px;">\n' +
                '        </a>\n' +
                '    </div>\n' +
                '    <div class="media-body">\n' +
                '        <h4 class="media-heading">@nickname@ <em style="font-size: xx-small;color: #9b9c9d9c">@createDate@</em></h4>' +
                '@content@</div>\n' +
                '</div>';
            let id = e.currentTarget.getAttribute('data-guest-id');
            $.ajax({
                url:'/blogs/GuestBookController/getComment?id='+id,
                type:'get',
                success:function (res) {
                    modalBody.innerHTML = '';
                    if (res.success){
                        let data = res.data;
                        let top = data.top;
                        let child = data.child;

                        let myself = data.myself;

                        let myselfEle= strToEleByObj(media,myself);
                        if (child){
                            let myselfEleBody  = myselfEle.querySelector('.media-body');
                            for (let i = 0; i < child.length; i++) {
                                let chi = child[i];

                                myselfEleBody.append(strToEleByObj(media,chi));
                            }
                        }
                        if (top){

                            let eleTop= strToEleByObj(media,top);
                            let eleTopBody  = eleTop.querySelector('.media-body');
                            modalBody.append(eleTop);

                            let siblings = data.siblings;
                            if (siblings){
                                for (let i = 0; i < siblings.length; i++) {
                                    let sibling = siblings[i];
                                    eleTopBody.append(strToEleByObj(media,sibling));
                                }
                            }
                            eleTopBody.append(myselfEle);

                        }else {
                            modalBody.append(myselfEle);
                        }

                        guestIsRead(id); //标记已读

                    }else {
                        modalBody.innerHTML = '<h1>没查到数据(⊙o⊙)？</h1>';
                    }
                },
                error:function (e) {
                    modalBody.innerHTML = '<h1>没查到数据(⊙o⊙)？</h1>';
                },
                beforeSend:function () {
                    modalBody.innerHTML ='<h1>Loading<span class="animated-dots"></span></h1>';
                }
            });

            console.log('正在打印')
            e.currentTarget.removeAttribute('data-guest-id')
        })



    });



</script>

